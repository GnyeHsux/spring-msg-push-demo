<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Websocket Demo</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="js/vconsole.min.js"></script>
</head>
<style>
    input {outline: none}
    .websocket {
        width: 800px;
        border: 1px solid #ccc;
        margin: 100px auto 0 auto;
        text-align: center;
    }

    .onLineUser {
        height: 600px;
        text-align: left;
        float: right;
        padding-right: 100px;
    }

    .receive {
    }

    #receive-box {
        width: 300px;
        height: 200px;
        overflow: auto;
        margin: 0 auto 24px auto;
        border: 1px black solid;
        border-radius: 10px;
    }

    #msg-need-send {
        width: 300px;
        height: 100px;
        resize: none;
        border-radius: 10px;
    }

    .sendBtn {
        border: none;
        border-radius: 5px;
        background: #25d1ff;
        padding: 5px 10px;
        color: #fff;
        cursor: pointer;
    }

    #exit {
        border: 1px solid #ccc;
        border-radius: 5px;
        background: none;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>
<script>
    var vConsole = new VConsole();
    // var ip = [[${ip}]];
    var ip = "localhost";
    // var ip = "172.17.13.72";



    var stompClient = null;
    var onlineUserList = [];

    function connect() {
        var socket = new SockJS('/stomp-websocket');
        stompClient = Stomp.over(socket);

        // 每隔30秒做一次心跳检测
        stompClient.heartbeat.outgoing = 30000;
        // 客户端不接收服务器的心跳检测
        stompClient.heartbeat.incoming = 0;

        if ($("#userId").val() == '') {
            alert("你是谁？");
            return;
        }

        var user = {
            'username': $("#userId").val(),
            'avatar': 'https://whycode.icu/user.jpeg',
            'address': "地球村"
        };
        stompClient.connect(user, function (frame) {
            $('#openSocket').attr("disabled", true);
            console.log('Connected: ' + frame);
            uid = frame.headers['user-name'];

            if (uid === undefined) {
                alert("建立连接失败，请重新连接！");
            }

            //订阅用户状态
            stompClient.subscribe('/topic/status', function (data) {
                data = JSON.parse(data.body).data;
                var msg = `<p style="color: orangered">${"系统消息: " + data.message}</p>`;
                showMsg(msg);
                //刷新在线列表
                flushOnlineGroup(data);
            });

            //订阅发给自己的消息
            stompClient.subscribe('/user/' + uid + '/chat', function (data) {
                data = JSON.parse(data.body).data;
                var msg = `<p style="color: black">${data.user.username + ": " + data.message}</p>`;
                showMsg(msg);
            });

            //订阅聊天室的消息
            stompClient.subscribe('/topic/chatRoom', function (data) {
                data = JSON.parse(data.body).data;
                if ($("#userId").val() === data.user.username) {
                    data.user.username = '我';
                }
                var msg = `<p style="color: black">${data.user.username + ": " + data.message}</p>`;
                showMsg(msg);
            });
        });

    }

    function flushOnlineGroup(data) {
        onlineUserList = data.onlineUserList;
        $("#olUser").empty();
        for (index in onlineUserList) {
            if (onlineUserList[index].userId != uid) {
                $("#olUser").append(`<li>${onlineUserList[index].username}</li>`)
            }
        }
        $("#users").empty();
        for (index in onlineUserList) {
            if (onlineUserList[index].userId != uid) {
                $("#users").append(`<option value="${onlineUserList[index].username}">`)
            }
        }
    }

    function disConnect() {
        // 客户端主动关闭连接
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        $('#openSocket').attr("disabled", false);
    }

    function openSocket() {
        var socketUrl = "ws://" + ip +":8081/wsServer/" + $("#userId").val();
        // var socketUrl = "ws://47.106.122.141:8080/wsServer/" + $("#userId").val();
        // 创建一个webSocket对象
        const ws = new WebSocket(socketUrl)
        ws.onopen = e => {
            // 连接后监听
            console.log(`WebSocket 连接状态： ${ws.readyState}`)
            if (1 == ws.readyState) {
                $('#openSocket').attr("disabled", true);
            }
        };

        ws.onmessage = data => {
            // 当服务端返回数据的时候，放到页面里
            var result = eval("(" + data.data + ")");
            var rstcode = result.rstcode;
            var msg = '';
            if ('0' == rstcode) {
                msg = `<p style="color: red">${result.fromUserId + ": " + result.msg}</p>`
            } else if ("2" == rstcode) {
                msg = `<p style="color: blue">${"离线消息【" + result.sendTime + "】：" + result.fromUserId + ": " + result.msg}</p>`
            } else if ("1" == rstcode){
                msg = `<p>${result.fromUserId + ": " + result.msg}</p>`
            } else if ("4" == rstcode) {
                msg = `<p style="color: blue">${"系统消息【" + result.sendTime + "】：" + result.msg}</p>`
            }
            showMsg(msg);
        };
        //发生了错误事件
        ws.onerror = function () {
            console.log("websocket发生了错误");
            showMsg(`<p style="color: red">通讯出错！！！</p>`)
        };
        ws.onclose = data => {
            // 监听连接关闭
            console.log("WebSocket连接已关闭")
            console.warn(data.reason);
            $('#openSocket').attr("disabled", false);
            showMsg(`<p style="color: red">你离线了</p>`)
        };

        $(".send").off('click', '#send-btn').on('click', '#send-btn', function () {
            if ($.trim($('#toUserId').val()).length > 0) {
                // 点击发送按钮。将数据发送给服务端
                ws.send('{"toUserId":"' + $("#toUserId").val() + '","msg":"' + $("#msg-need-send").val() + '"}')
                showMsg(`<p>${$("#userId").val() + ": " + $("#msg-need-send").val()}</p>`)
                $("#msg-need-send").val('');
            }
        });

        $(".send").off('click', '#send-group-btn').on('click', '#send-group-btn', function () {
            if ($.trim($('#toUserId').val()).length > 0) {
                // 点击发送按钮。将数据发送给服务端
                ws.send('{"toGroupId":"' + $("#toGroupId").val() + '","msg":"' + $("#msg-need-send").val() + '"}')
                showMsg(`<p>${$("#userId").val() + ": " + $("#msg-need-send").val()}</p>`)
                $("#msg-need-send").val('');
            }
        });

        $(".websocket").off('click', '#exit').on('click', '#exit', function () {
            // 客户端主动关闭连接
            ws.close()
        });
    }

    function showMsg(data) {
        var receiveBox = document.getElementById("receive-box")
        receiveBox.innerHTML += `${data}`
        receiveBox.scrollTo({
            top: receiveBox.scrollHeight,
            behavior: "smooth"
        })
    }

    function sendMsg(type) {
        // 获取发送的内容
        var content = $("#msg-need-send").val();
        // 内容不能为空
        if (content.trim().length < 1) {
            return;
        }

        var data = {
            "message": content
        };
        var pub = '/app/chatRoom';
        if ('user' === type) {
            pub = '/app/chat';
            data.receiver = [getUserIdByName($("#toUserId").val())];
        }

        data = JSON.stringify(data);
        sendMessage(pub, {}, data);

        if ('user' === type) {
            var msg = `<p style="color: black">${"我: " + content}</p>`;
            showMsg(msg);
        }

        $("#msg-need-send").val('');
    }
    /**
     * 发送信息到指定地址
     * @param pub 发布地址
     * @param header 设置请求头
     * @param data 发送的内容
     */
    function sendMessage(pub, header, data) {
        stompClient.send(pub, header, data);
    }

    /**
     * 通过name获取userid
     * @param name
     * @returns {Document.userId|string}
     */
    function getUserIdByName(name) {
        if (name == '') {
            return '';
        }

        for (var i = 0; i < onlineUserList.length; i++) {
            var obj = onlineUserList[i];
            if (obj.userId !== uid && obj.username === name) {
                return obj.userId;
            }
        }
    }

</script>
<body>
<div class="websocket">
    <div class="onLineUser">
        <p>在线用户：</p>
        <ol id="olUser">
        </ol>
    </div>
    <div>
        <p>【我是】： <input id="userId" name="userId" type="text" value="收银员">
        <p>【发送给】： <input list="users" id="toUserId" name="toUserId">
        <datalist id="users">
        </datalist>
<!--        <p>【发送到群】： <input id="toGroupId" name="toGroupId" type="text" value="东湖门店组">-->
        <p>【操作】：<button id="openSocket" onclick="connect()">开启socket通讯</button>
    </div>
    <div class="receive">
        <p>服务端返回的消息</p>
        <div id="receive-box"></div>
    </div>
    <div class="send">
        <textarea type="text" id="msg-need-send"></textarea>
        <p>
            <button class="sendBtn" id="send-btn" onclick="sendMsg('user')">发个人消息</button>
            <button class="sendBtn" id="send-group-btn" onclick="sendMsg('group')">发群消息</button>
        </p>
    </div>
    <button id="exit" onclick="disConnect()">关闭连接</button>
</div>
</body>
</html>