<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Websocket Demo</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="js/vconsole.min.js"></script>
</head>
<style>
    input {outline: none}
    .websocket {
        width: 800px;
        border: 1px solid #ccc;
        margin: 100px auto 0 auto;
        text-align: center;
    }

    .onLineUser {
        height: 600px;
        text-align: left;
        float: right;
        padding-right: 100px;
    }

    .receive {
    }

    #receive-box {
        width: 300px;
        height: 200px;
        overflow: auto;
        margin: 0 auto 24px auto;
        border: 1px black solid;
        border-radius: 10px;
    }

    #msg-need-send {
        width: 300px;
        height: 100px;
        resize: none;
        border-radius: 10px;
    }

    .sendBtn {
        border: none;
        border-radius: 5px;
        background: #25d1ff;
        padding: 5px 10px;
        color: #fff;
        cursor: pointer;
    }

    #exit {
        border: 1px solid #ccc;
        border-radius: 5px;
        background: none;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>
<script>

    var vConsole = new VConsole();

    var stompClient = null;
    var onlineUserList = [];

    function connect() {
        var socket = new SockJS('/stomp-websocket');
        stompClient = Stomp.over(socket);

        // 每隔30秒做一次心跳检测
        stompClient.heartbeat.outgoing = 30000;
        // 客户端不接收服务器的心跳检测
        stompClient.heartbeat.incoming = 0;

        if ($("#userId").val() == '') {
            alert("你是谁？");
            return;
        }

        var user = {
            'username': $("#userId").val(),
            'avatar': 'https://whycode.icu/user.jpeg',
            'address': "地球村"
        };
        stompClient.connect(user, function (frame) {
            $('#openSocket').attr("disabled", true);
            console.log('Connected: ' + frame);
            uid = frame.headers['user-name'];

            if (uid === undefined) {
                alert("建立连接失败，请重新连接！");
            }

            //订阅用户状态
            stompClient.subscribe('/topic/status', function (data) {
                data = JSON.parse(data.body).data;
                var msg = `<p style="color: orangered">${"系统消息: " + data.message}</p>`;
                showMsg(msg);
                //刷新在线列表
                flushOnlineGroup(data);
            });

            //订阅发给自己的消息
            stompClient.subscribe('/user/' + uid + '/chat', function (data) {
                data = JSON.parse(data.body).data;
                if (uid === data.user.userId) {
                    data.user.username = '我';
                }
                if (data.type == 'REVOKE') {
                    var obj = document.getElementById(data.revokeMessageId);
                    obj.remove();
                    showMsg(`<p style="color: gray">${data.user.username + '撤回了一条消息！'}</p>`)
                } else {
                    var msg = `<p style="color: black" ondblclick="revokeMsg(this)" receiver="${data.receiver}" id="${data.messageId}">${data.user.username + ": " + data.message}</p>`;
                    showMsg(msg);
                }
            });

            //订阅聊天室的消息
            stompClient.subscribe('/topic/chatRoom', function (data) {
                data = JSON.parse(data.body).data;
                if (uid === data.user.userId) {
                    data.user.username = '我';
                }
                if (data.type == 'REVOKE') {
                    var obj = document.getElementById(data.revokeMessageId);
                    obj.remove();
                    showMsg(`<p style="color: gray">${data.user.username + '撤回了一条消息！'}</p>`)
                } else {
                    var msg = `<p style="color: black" ondblclick="revokeMsg(this)" receiver="${data.receiver}" id="${data.messageId}">${data.user.username + ": " + data.message}</p>`;
                    showMsg(msg);
                }
            });

            // 错误信息订阅
            stompClient.subscribe('/user/' + uid + '/error', function (data) {
                getData(data.body);
            });
        });

    }

    /**
     * 解析响应数据
     * @param data
     * @returns {*}
     */
    function getData(data) {
        var obj = JSON.parse(data);
        codeMapping(obj);
        return obj.data;
    }

    /**
     * 响应码映射
     * @param date
     */
    function codeMapping(date) {
        switch (date.code) {
            case 200:
                break;
            case 404:
                alert("404");
                break;
            default:
                alert(date.desc);
                break;
        }
    }

    function flushOnlineGroup(data) {
        onlineUserList = data.onlineUserList;
        $("#olUser").empty();
        for (index in onlineUserList) {
            if (onlineUserList[index].userId != uid) {
                $("#olUser").append(`<li>${onlineUserList[index].username}</li>`)
            }
        }
        $("#toUserId").empty();
        for (index in onlineUserList) {
            if (onlineUserList[index].userId != uid) {
                $("#toUserId").append(`<option value="${onlineUserList[index].userId}">${onlineUserList[index].username}</option>`)
            }
        }
    }

    function disConnect() {
        // 客户端主动关闭连接
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        $('#openSocket').attr("disabled", false);
    }

    function showMsg(data) {
        var receiveBox = document.getElementById("receive-box")
        receiveBox.innerHTML += `${data}`
        receiveBox.scrollTo({
            top: receiveBox.scrollHeight,
            behavior: "smooth"
        })
    }

    function sendMsg(type) {
        // 获取发送的内容
        var content = $("#msg-need-send").val();
        // 内容不能为空
        if (content.trim().length < 1) {
            return;
        }

        var data = {
            "message": content
        };
        var pub = '/chatRoom';
        if ('user' === type) {
            pub = '/chat';
            data.receiver = [$("#toUserId").val(), uid];
        }

        data = JSON.stringify(data);
        sendMessage(pub, {}, data);

        $("#msg-need-send").val('');
    }

    function revokeMsg(e) {
        var dom = $(e);
        var messageId = dom.attr("id");
        var receiver = dom.attr("receiver")

        if (receiver === null || receiver === '' || receiver === 'null' || messageId === undefined) {
            receiver = null;
        } else {
            receiver = receiver.split(',');
        }

        var data = JSON.stringify({
            'messageId': messageId,
            'receiver': receiver
        });

        sendMessage('/chatRoom/revoke', {}, data);
    }
    /**
     * 发送信息到指定地址
     * @param pub 发布地址
     * @param header 设置请求头
     * @param data 发送的内容
     */
    function sendMessage(pub, header, data) {
        stompClient.send(pub, header, data);
    }

    /**
     * 通过name获取userid
     * @param name
     * @returns {Document.userId|string}
     */
    function getUserIdByName(name) {
        if (name == '') {
            return '';
        }

        for (var i = 0; i < onlineUserList.length; i++) {
            var obj = onlineUserList[i];
            if (obj.userId !== uid && obj.username === name) {
                return obj.userId;
            }
        }
    }

</script>
<body>
<div class="websocket">
    <div class="onLineUser">
        <p>在线用户：</p>
        <ol id="olUser">
        </ol>
    </div>
    <div>
        <p>【我是】： <input id="userId" name="userId" type="text" value="收银员">
        <p>【发送给】： <select style="width: 130px" id="toUserId"></select>
<!--        <p>【发送到群】： <input id="toGroupId" name="toGroupId" type="text" value="东湖门店组">-->
        <p>【操作】：<button id="openSocket" onclick="connect()">开启socket通讯</button>
    </div>
    <div class="receive">
        <p>服务端返回的消息</p>
        <div id="receive-box"></div>
    </div>
    <div class="send">
        <textarea type="text" id="msg-need-send"></textarea>
        <p>
            <button class="sendBtn" id="send-btn" onclick="sendMsg('user')">推送个人消息</button>
            <button class="sendBtn" id="send-group-btn" onclick="sendMsg('group')">推送全局消息</button>
        </p>
    </div>
    <button id="exit" onclick="disConnect()">关闭连接</button>
</div>
</body>
</html>